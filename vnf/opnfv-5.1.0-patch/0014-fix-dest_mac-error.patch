From 0072e98c32a07c092905e591e33e0c7e7ad856af Mon Sep 17 00:00:00 2001
From: anlaneg <anlaneg@example.com>
Date: Mon, 29 Jan 2018 18:06:37 +0800
Subject: [PATCH 14/14] fix dest_mac error

---
 VNFs/vCGNAPT/pipeline/pipeline_cgnapt_be.c | 43 +++++++++++++++---------------
 1 file changed, 22 insertions(+), 21 deletions(-)

diff --git a/VNFs/vCGNAPT/pipeline/pipeline_cgnapt_be.c b/VNFs/vCGNAPT/pipeline/pipeline_cgnapt_be.c
index e58e0d3..f0e426b 100644
--- a/VNFs/vCGNAPT/pipeline/pipeline_cgnapt_be.c
+++ b/VNFs/vCGNAPT/pipeline/pipeline_cgnapt_be.c
@@ -3736,17 +3736,17 @@ pkt_work_cgnapt_ipv4_prv(
 
 	gw_get_nh_port_ipv4(dest_address, &dest_if, &nhip);
 
-	ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
-			(struct ether_addr *)eth_dest);
-
-	*outport_id = p_nat->outport_id[dest_if];
-
-	//save old ether header
+	//save older ether header
 	uint8_t srcmac[6];
 	uint8_t dstmac[6];
 	memcpy(dstmac,eth_dest,sizeof(dstmac));
 	memcpy(srcmac,eth_src,sizeof(srcmac));
 
+	ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
+			(struct ether_addr *)eth_dest);
+
+	*outport_id = p_nat->outport_id[dest_if];
+
 	if (arp_cache_dest_mac_present(dest_if)) {
 		ether_addr_copy(get_link_hw_addr(dest_if),(struct ether_addr *)eth_src);
 		update_nhip_access(dest_if);
@@ -4117,16 +4117,16 @@ pkt_work_cgnapt_ipv4_pub(
 
 	gw_get_nh_port_ipv4(dest_address, &dest_if, &nhip);
 
-	ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
-			(struct ether_addr *)eth_dest);
-	*outport_id = p_nat->outport_id[dest_if];
-
-	//save old ether header
+	//save older ether header
 	uint8_t srcmac[6];
 	uint8_t dstmac[6];
 	memcpy(dstmac,eth_dest,sizeof(dstmac));
 	memcpy(srcmac,eth_src,sizeof(srcmac));
 
+	ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
+			(struct ether_addr *)eth_dest);
+	*outport_id = p_nat->outport_id[dest_if];
+
 	if (arp_cache_dest_mac_present(dest_if)) {
 		ether_addr_copy(get_link_hw_addr(dest_if), (struct ether_addr *)eth_src);
 		update_nhip_access(dest_if);
@@ -4594,17 +4594,18 @@ pkt4_work_cgnapt_ipv4_prv(
 
 		gw_get_nh_port_ipv4(dest_address, &dest_if, &nhip);
 
-		ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
-				(struct ether_addr *)eth_dest);
-
-		*outport_id = p_nat->outport_id[dest_if];
-
 		//save older ether header
 		uint8_t srcmac[6];
 		uint8_t dstmac[6];
 		memcpy(dstmac,eth_dest,sizeof(dstmac));
 	    memcpy(srcmac,eth_src,sizeof(srcmac));
 
+		ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
+				(struct ether_addr *)eth_dest);
+
+		*outport_id = p_nat->outport_id[dest_if];
+
+
 		if (arp_cache_dest_mac_present(dest_if)) {
 			ether_addr_copy(get_link_hw_addr(dest_if),
 				 (struct ether_addr *)eth_src);
@@ -4992,17 +4993,17 @@ pkt4_work_cgnapt_ipv4_pub(
 
 		gw_get_nh_port_ipv4(dest_address, &dest_if, &nhip);
 
-		ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
-				(struct ether_addr *)eth_dest);
-
-		*outport_id = p_nat->outport_id[dest_if];
-
 		//save older ether header
 		uint8_t srcmac[6];
 		uint8_t dstmac[6];
 		memcpy(dstmac,eth_dest,sizeof(dstmac));
 		memcpy(srcmac,eth_src,sizeof(srcmac));
 
+		ret_arp_data = get_dest_mac_addr_ipv4(nhip, dest_if,
+				(struct ether_addr *)eth_dest);
+
+		*outport_id = p_nat->outport_id[dest_if];
+
 		if (arp_cache_dest_mac_present(dest_if)) {
 			ether_addr_copy(get_link_hw_addr(dest_if),
 					(struct ether_addr *)eth_src);
-- 
2.7.4

